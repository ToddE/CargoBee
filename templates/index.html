<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConTetris | Container Load Calculator</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§©</text></svg>">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      }
    </script>
</head>
<body class="font-sans">
    <div class="container mx-auto max-w-7xl p-4 md:p-8">
        <h1 class="text-4xl font-bold text-gray-800 pb-2 mb-2 border-b">ConTetris ðŸ§©</h1>
        <p class="text-gray-600 mb-6">A simple web-based logistics calculator designed to solve the common "Container Tetris" puzzle of optimally loading cargo into shipping containers</p>

        <div class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-[400px_1fr_400px] gap-8">
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Input Parameters</h2>
                <p class="text-sm text-gray-600 mb-6">Select your shipment type and fill in the details. Save the configuration as a named profile for easy recall.</p>
                
                <form id="calc-form" action="/" method="post" class="space-y-4">
                    <div>
                        <strong class="text-sm font-medium text-gray-700 flex items-center">
                            Shipment Type
                            <span class="group relative ml-2">
                                <span class="cursor-help rounded-full border border-gray-400 text-gray-400 w-5 h-5 flex items-center justify-center text-sm">?</span>
                                <span class="absolute bottom-full left-1/2 -translate-x-1/2 w-48 p-2 bg-gray-700 text-white text-sm rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                    Choose <b>Palletized</b> to stack cartons on pallets, or <b>Floor-Loaded</b> to place cartons directly in the container.
                                </span>
                            </span>
                        </strong>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center"><input id="type-palletized" type="radio" name="shipment_type" value="palletized" checked onchange="togglePalletFields()" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2 text-gray-700">Palletized</span></label>
                            <label class="flex items-center"><input id="type-floor" type="radio" name="shipment_type" value="floor_loaded" onchange="togglePalletFields()" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500"> <span class="ml-2 text-gray-700">Floor-Loaded</span></label>
                        </div>
                    </div>
                    
                    <div>
                        <label for="total_cartons" class="block text-sm font-medium text-gray-700">Total # of Cartons to Ship</label>
                        <input id="total_cartons" type="number" name="total_cartons" value="{{ form_inputs.total_cartons | default('2000') }}" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>
                    
                    <div>
                        <label for="carton_weight" class="block text-sm font-medium text-gray-700">Weight per Carton (kg)</label>
                        <input id="carton_weight" type="number" name="carton_weight" value="{{ form_inputs.carton_weight | default('10') }}" step="any" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Carton Dimensions (cm)</label>
                        <div class="grid grid-cols-3 gap-2 mt-1">
                            <input id="carton_l" type="number" name="carton_l" placeholder="L" value="{{ form_inputs.carton_l | default('30') }}" step="any" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <input id="carton_w" type="number" name="carton_w" placeholder="W" value="{{ form_inputs.carton_w | default('23') }}" step="any" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            <input id="carton_h" type="number" name="carton_h" placeholder="H" value="{{ form_inputs.carton_h | default('15') }}" step="any" required class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                    
                    <div id="pallet-fields" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Pallet Dimensions (cm)</label>
                            <div class="grid grid-cols-3 gap-2 mt-1">
                                <input id="pallet_l" type="number" name="pallet_l" value="{{ form_inputs.pallet_l | default('120') }}" step="any" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <input id="pallet_w" type="number" name="pallet_w" value="{{ form_inputs.pallet_w | default('100') }}" step="any" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                                <input id="pallet_h" type="number" name="pallet_h" value="{{ form_inputs.pallet_h | default('15') }}" step="any" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                            </div>
                        </div>
                        <div>
                            <label for="max_pallet_h" class="block text-sm font-medium text-gray-700 flex items-center">
                                Max Pallet Height (cm)
                                <span class="group relative ml-2">
                                    <span class="cursor-help rounded-full border border-gray-400 text-gray-400 w-5 h-5 flex items-center justify-center text-sm">?</span>
                                    <span class="absolute bottom-full left-1/2 -translate-x-1/2 w-48 p-2 bg-gray-700 text-white text-sm rounded-md shadow-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none">
                                        <b>IMPORTANT:</b> Enter the maximum total height (pallet + cartons) that your warehouse racking or equipment can handle.
                                    </span>
                                </span>
                            </label>
                            <input id="max_pallet_h" type="number" name="max_pallet_h" value="{{ form_inputs.max_pallet_h | default('152.4') }}" step="any" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        </div>
                    </div>
                    
                    <div class="space-y-2 pt-4">
                        <button id="btn-calculate" type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Calculate Optimal Load</button>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-share" type="button" onclick="generateShareLink()" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">Copy Share Link</button>
                            <button id="btn-save-ui" type="button" onclick="toggleSaveUI()" class="w-full flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Save to Browser</button>
                        </div>
                    </div>
                    
                    <div id="save-container" class="border-t pt-4 mt-4" style="display: none;">
                        <label for="profile_name" class="block text-sm font-medium text-gray-700">Profile Name</label>
                        <input id="profile_name" type="text" placeholder="e.g., Q4 Widget Shipment" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">
                        <button id="btn-save-confirm" type="button" onclick="saveProfile()" class="mt-2 w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">Confirm Save</button>
                    </div>
                </form>
            </div>
            
            <div class="bg-blue-50 p-6 rounded-lg shadow-sm border border-blue-200 lg:col-span-2 xl:col-span-1">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Results</h2>
                {% if error %} <p class="text-red-600 font-semibold">{{ error }}</p> {% endif %}
                {% if results %}
                    <div class="space-y-3">
                        <p class="text-gray-800"><strong class="font-semibold text-blue-800">Recommended Containers:</strong> {{ results.recommendation }}</p>
                        <p class="text-gray-800"><strong class="font-semibold text-blue-800">Total Cargo Weight:</strong> {{ results.total_weight_kg }} kg <span class="{{ 'text-green-600' if 'OK' in results.weight_status else 'text-red-600' }} font-bold">({{ results.weight_status }})</span></p>
                        {% if results.total_pallets %} <p class="text-gray-800"><strong class="font-semibold text-blue-800">Total Pallets to Build:</strong> {{ results.total_pallets }}</p> {% endif %}
                        <div class="border-t pt-3">
                            <h3 class="text-lg font-semibold text-blue-800">Configuration Details:</h3>
                            <ul class="list-disc list-inside text-gray-700 mt-2"> {% for config in results.pallet_configs %} <li>{{ config }}</li> {% endfor %} </ul>
                        </div>
                    </div>
                {% else %}
                    <p class="text-gray-500">Enter your shipment details to see the results.</p>
                {% endif %}
            </div>

            <div class="bg-white p-6 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">Saved Profiles</h2>
                <ul id="profile-list" class="space-y-2"></ul>
            </div>
        </div>
    </div>

    <footer class="text-center py-4">
        <p class="text-sm text-gray-500">ConTetris v{{ version }}</p>
    </footer>

    <script>
        // All JavaScript is unchanged and correct
        const inputIds = [ 'total_cartons', 'carton_weight', 'carton_l', 'carton_w', 'carton_h', 'pallet_l', 'pallet_w', 'pallet_h', 'max_pallet_h' ];
        function generateShareLink() {
            const params = new URLSearchParams();
            params.append('shipment_type', document.querySelector('input[name="shipment_type"]:checked').value);
            inputIds.forEach(id => { const element = document.getElementById(id); if (element.value) { params.append(id, element.value); } });
            const shareUrl = window.location.origin + window.location.pathname + '?' + params.toString();
            navigator.clipboard.writeText(shareUrl).then(() => {
                const shareButton = document.getElementById('btn-share');
                shareButton.textContent = 'Link Copied!';
                setTimeout(() => { shareButton.textContent = 'Copy Share Link'; }, 2000);
            }, () => { alert('Failed to copy link.'); });
        }
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.has('total_cartons')) {
                if (params.get('shipment_type') === 'floor_loaded') { document.getElementById('type-floor').checked = true; } else { document.getElementById('type-palletized').checked = true; }
                inputIds.forEach(id => { if (params.has(id)) { document.getElementById(id).value = params.get(id); } });
                togglePalletFields();
                return true;
            }
            return false;
        }
        function togglePalletFields() { const p = document.getElementById('pallet-fields'); p.style.display = document.getElementById('type-palletized').checked ? 'block' : 'none'; }
        function getProfiles() { return JSON.parse(localStorage.getItem('conTetrisProfiles') || '[]'); }
        function saveProfiles(p) { localStorage.setItem('conTetrisProfiles', JSON.stringify(p)); }
        function renderProfiles() { 
            const p = getProfiles(); 
            const pl = document.getElementById('profile-list'); 
            pl.innerHTML = ''; 
            if (p.length === 0) { pl.innerHTML = '<p class="text-gray-500 text-sm">No saved profiles yet.</p>'; return; } 
            p.forEach(pf => { 
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center p-2 border-b';
                li.innerHTML = `<span class="text-gray-700">${pf.name}</span><div><button class="text-xs font-medium text-white bg-teal-600 hover:bg-teal-700 rounded py-1 px-2" onclick="loadProfile('${pf.name}')">Load</button><button class="text-xs font-medium text-white bg-red-600 hover:bg-red-700 rounded py-1 px-2 ml-1" onclick="deleteProfile('${pf.name}')">Delete</button></div>`; 
                pl.appendChild(li); 
            }); 
        }
        function toggleSaveUI() { const sc = document.getElementById('save-container'); sc.style.display = sc.style.display === 'none' ? 'block' : 'none'; }
        function saveProfile() { const pn = document.getElementById('profile_name').value.trim(); if (!pn) { alert('Please enter a name.'); return; } const i = {}; i.shipment_type = document.querySelector('input[name="shipment_type"]:checked').value; inputIds.forEach(id => { i[id] = document.getElementById(id).value; }); let ps = getProfiles(); const ei = ps.findIndex(p => p.name === pn); if (ei > -1) { if (confirm(`Overwrite "${pn}"?`)) { ps[ei].inputs = i; } else { return; } } else { ps.push({ name: pn, inputs: i }); } saveProfiles(ps); renderProfiles(); toggleSaveUI(); document.getElementById('profile_name').value = ''; }
        function loadProfile(pn) { const p = getProfiles().find(p => p.name === pn); if (p) { const i = p.inputs; if (i.shipment_type === 'floor_loaded') { document.getElementById('type-floor').checked = true; } else { document.getElementById('type-palletized').checked = true; } inputIds.forEach(id => { if (i[id]) { document.getElementById(id).value = i[id]; } }); togglePalletFields(); } }
        function deleteProfile(pn) { if (confirm(`Delete "${pn}"?`)) { let p = getProfiles().filter(p => p.name !== pn); saveProfiles(p); renderProfiles(); } }
        document.addEventListener('DOMContentLoaded', () => { if (!loadFromURL()) { /* Optionally load last profile from storage here */ } renderProfiles(); });
    </script>
</body>
</html>